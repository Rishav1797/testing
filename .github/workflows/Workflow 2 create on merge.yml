name: Create input.json from PR artifact on merge

on:
  workflow_run:
    workflows: ["Validate PR Template & Upload Artifact"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  create-from-artifact:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout base repo
        uses: actions/checkout@v4

      - name: Get PR number from workflow event
        id: pr_info
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const eventPayload = ${{ toJSON(github.event.workflow_run) }};
            
            console.log('Workflow run event:');
            console.log(JSON.stringify(eventPayload, null, 2));
            
            // Get PR number from pull requests array or head_branch
            let prNumber = null;
            if (eventPayload.pull_requests && eventPayload.pull_requests.length > 0) {
              prNumber = eventPayload.pull_requests[0].number;
            }
            
            core.setOutput('pr_number', prNumber || '0');
            console.log(`PR Number: ${prNumber}`);

      - name: Download artifact
        uses: actions/download-artifact@v4
        if: steps.pr_info.outputs.pr_number != '0'
        with:
          name: pr-${{ steps.pr_info.outputs.pr_number }}-input-json
          github-token: ${{ github.token }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Parse artifact and create files
        if: steps.pr_info.outputs.pr_number != '0'
        run: |
          set -e
          
          PR_NUMBER="${{ steps.pr_info.outputs.pr_number }}"
          echo "Processing PR #$PR_NUMBER"
          echo "Current directory: $(pwd)"
          echo "Contents:"
          ls -la
          
          # Find artifact file
          ARTIFACT_FILE=$(find . -name "*input-json" -type f 2>/dev/null | head -1)
          
          if [ -z "$ARTIFACT_FILE" ]; then
            echo "❌ Artifact file not found"
            echo "Searching for files..."
            find . -type f | head -20
            exit 0
          fi
          
          echo "✓ Found artifact: $ARTIFACT_FILE"
          
          # Read artifact payload
          PAYLOAD=$(cat "$ARTIFACT_FILE")
          echo "Artifact content:"
          echo "$PAYLOAD"
          
          # Parse JSON
          TARGETS=$(echo "$PAYLOAD" | jq -r '.targets[]')
          DATA=$(echo "$PAYLOAD" | jq '.data')
          
          echo ""
          echo "Creating input.json files for:"
          echo "$TARGETS"
          
          # Create input.json in each target directory
          CREATED_FILES=()
          while IFS= read -r target; do
            if [ -z "$target" ]; then
              continue
            fi
            
            FILE_PATH="$target/input.json"
            echo "Creating: $FILE_PATH"
            
            mkdir -p "$target"
            echo "$DATA" | jq '.' > "$FILE_PATH"
            
            CREATED_FILES+=("$FILE_PATH")
          done <<< "$TARGETS"
          
          if [ ${#CREATED_FILES[@]} -eq 0 ]; then
            echo "No files created"
            exit 0
          fi
          
          # Check for changes
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Commit
          git add -A
          git commit -m "Auto-generate input.json from PR #$PR_NUMBER"
          
          # Get the target branch from the workflow event
          TARGET_BRANCH="${{ github.event.workflow_run.head_branch }}"
          if [ -z "$TARGET_BRANCH" ]; then
            TARGET_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          fi
          
          git push origin "$TARGET_BRANCH"
          
          echo ""
          echo "✓ Successfully created and pushed:"
          printf '%s\n' "${CREATED_FILES[@]}"

      - name: Post success comment
        if: steps.pr_info.outputs.pr_number != '0'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = parseInt('${{ steps.pr_info.outputs.pr_number }}');
            
            if (prNumber > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: "✅ **PR Merged** - input.json files have been created and committed to the repository."
              });
            }
